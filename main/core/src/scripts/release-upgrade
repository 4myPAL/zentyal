#!/bin/bash

UPGRADE_FILE=/var/lib/zentyal/.upgrade-finished

rm -f $UPGRADE_FILE

export DEBIAN_FRONTEND=noninteractive

function echoTS
{
     echo "$(date "+%Y/%m/%d %T") $1"
}

function upgrade
{
    apt-get update

    for i in `seq 1 10`
    do
        if apt-get dist-upgrade -y --force-yes --download-only
        then
            break
        else
            echoTS "Download failed, retrying in 5 seconds..."
            sleep 5
        fi
    done

    apt-get dist-upgrade --purge -y --force-yes -o DPkg::Options::="--force-confdef"
}


sed -i "s/^deb-src/#deb-src/g" /etc/apt/sources.list

echo; echoTS "Upgrading your current system to the latest packages..."; echo
upgrade

echo; echoTS "Upgrading from Zentyal 3.5 to 4.0..."; echo
sed -ri 's/zentyal(.)3.5/zentyal\14.0/g' /etc/apt/sources.list

# remove psgi programs to avoid webadmin failures
rm -f  /var/lib/zentyal/conf/webadmin/psgi-subapps.yaml 

upgrade

for i in `seq 1 3`
do
    echo; echoTS "Forcing pending packages installation..."; echo
    apt-get -f install -y --force-yes -o DPkg::Options::="--force-confdef"
    rm -f /var/lib/dpkg/info/suricata.prerm
    for pkg in freeradius-ldap suricata rabbitmq-server
    do
        mv -f /var/lib/dpkg/info/${pkg}.postinst /var/lib/dpkg/info/old.${pkg}.postinst
    done
    dpkg --configure -a --force-confdef
    apt-get dist-upgrade --purge -y --force-yes -o DPkg::Options::="--force-confdef"
    if [ $? == 0 ]
    then
        echo; echoTS "Nothing more pending to upgrade"; echo
        break
    fi
done

if apt-get dist-upgrade --purge -y --force-yes -o DPkg::Options::="--force-confdef"
then
    for pkg in freeradius-ldap suricata rabbitmq-server
    do
        mv -f /var/lib/dpkg/info/old.${pkg}.postinst /var/lib/dpkg/info/${pkg}.postinst
    done

    service haproxy stop

    /usr/share/zentyal/global-action --action saveAllModules

    # Purge all no longer needed running services like collectd, etc
    apt-get autoremove --purge -y --force-yes -o DPkg::Options::="--force-confdef"
    # Purge haproxy to  avoid future problems with taking ports
    apt-get remove --purge -y --force-yes -o DPkg::Options::="--force-confdef" haproxy

    # Restart regular webserver and Zentyal UI
    service apache2 restart
    service zentyal webadmin restart

    echo; echoTS "Zentyal upgrade finished!"
else
    echo; echoTS "Zentyal upgrade failed. Full log at /var/log/zentyal/upgrade.log."
fi

apt-get clean

touch $UPGRADE_FILE
