#!/bin/bash

UPGRADE_FILE=/var/lib/zentyal/.upgrade-finished

rm -f $UPGRADE_FILE

export DEBIAN_FRONTEND=noninteractive

function upgrade
{
    apt-get update

    for i in `seq 1 10`
    do
        if apt-get dist-upgrade -y --force-yes --download-only $@
        then
            break
        else
            echo "Download failed, retrying in 5 seconds..."
            sleep 5
        fi
    done

    apt-get dist-upgrade -y --force-yes -o DPkg::Options::="--force-overwrite" -o DPkg::Options::="--force-confdef" $@
}

sed -i "s/^deb-src/#deb-src/g" /etc/apt/sources.list

echo; echo "Upgrading your current system to the latest packages..."; echo
upgrade

# Migrate redis data
stop ebox.redis
service redis-server stop
cp /var/lib/zentyal/dump.rdb /var/lib/redis/dump.rdb
service redis-server start
sed -i 's/redis_port = 6380/redis_port = 6379/' /etc/zentyal/core.conf

# Prepare for upgrade of commercial edition if it's the case
/usr/share/zentyal/shell '$global->communityEdition() or system("touch /var/lib/zentyal/.commercial-edition")'

# Stop services that are going to be deprecated
for i in printers antivirus mailfilter
do
    service zentyal $i stop 2>/dev/null || true
done

#Move the stubs and hooks folder to a safer place so it can be recovered but don't interfere with the upgrade
mv /etc/zentyal/stubs /etc/zentyal/stubs.50upgrade.bak
mv /etc/zentyal/hooks /etc/zentyal/hooks.50upgrade.bak

echo; echo "Upgrading from Ubuntu 14.04 to 16.04 with Zentyal 5.0..."; echo
sed -i 's/trusty/xenial/g' /etc/apt/sources.list
sed -ri '/zentyal(.)4.2/d' /etc/apt/sources.list
echo 'deb http://archive.zentyal.org/zentyal 5.0 main' > /etc/apt/sources.list.d/zentyal-archive.list
# FIXME: overwrite zentyal-qa.list with proper repo prompting license key on commandline if .commercial-edition
#sed -i 's/zentyal-qa-4.2/zentyal-qa-5.0/g' /etc/apt/sources.list.d/zentyal-qa.list

# Workaround to avoid dependency problems when packages are hold
for e in `grep -R "a=zentyal-qa" /etc/apt | cut -f1 -d:`; do rm -f $e; done

# FIXME: do it for QA repo instead (archive.zentyal.com) if upgrading commercial edition
cat <<EOF > /etc/apt/preferences
Package: *
Pin: origin "archive.zentyal.org"
Pin-Priority: 1001
EOF

# "Downgrade" samba first together with the dist-upgrade to avoid dependency problems
if dpkg -l|grep ^ii|grep -q zentyal-samba
then
    SAMBA_INSTALLED=$(apt-cache policy samba|grep Installed: | cut -d' ' -f4)
    dpkg -l|grep $SAMBA_INSTALLED|cut -d' ' -f3 > samba_packages.list
    echo libnss-winbind >> samba_packages.list
    echo libpam-winbind >> samba_packages.list
    echo zentyal-samba >> samba_packages.list
    PACKAGES=$(cat samba_packages.list | xargs)
fi

upgrade $PACKAGES

rm -f samba_packages.list
rm -f /etc/apt/preferences

if apt-get dist-upgrade --purge -y --force-yes -o DPkg::Options::="--force-confdef"
then
    # Purge all no longer needed running services
    dpkg -l | grep 'zentyal-' | cut -d' ' -f3 | xargs apt-mark manual
    apt-get autoremove --purge -y --force-yes -o DPkg::Options::="--force-confdef"

    apt-get -f install -y --force-yes -o DPkg::Options::="--force-confdef"

    dpkg --configure -a --force-confdef

    systemctl enable zentyal

    echo; echo "Zentyal upgrade finished! Please restart your server now."
else
    echo; echo "Zentyal upgrade failed. Full log at /var/log/zentyal/upgrade.log."
fi

apt-get clean

touch $UPGRADE_FILE
