#!/bin/bash

UPGRADE_FILE=/var/lib/zentyal/.upgrade-finished

rm -f $UPGRADE_FILE

export DEBIAN_FRONTEND=noninteractive

function upgrade
{
    apt-get update

    for i in `seq 1 10`
    do
        if apt-get dist-upgrade -y --force-yes --download-only
        then
            break
        else
            echo "Download failed, retrying in 5 seconds..."
            sleep 5
        fi
    done

    apt-get dist-upgrade --purge -y --force-yes -o DPkg::Options::="--force-confdef"
}

sed -i "s/^deb-src/#deb-src/g" /etc/apt/sources.list

echo; echo "Upgrading your current system to the latest packages..."; echo
upgrade

# Install samba if missing and replicate users with s4sync
/usr/share/zentyal/migrate-users-to-samba

# Stop slapd
service zentyal users stop

echo; echo "Upgrading from Ubuntu 12.04 to 14.04 with Zentyal 4.0..."; echo
sed -i 's/precise/trusty/g' /etc/apt/sources.list
sed -ri '/zentyal(.)3.2/d' /etc/apt/sources.list
rm -f /etc/apt/sources.list.d/zentyal*
echo 'deb http://archive.zentyal.org/zentyal 4.0 main extra' >> /etc/apt/sources.list
# FIXME: remove this before releasing
echo 'deb http://archive.zentyal.org/zentyal-beta 4.0-proposed main extra' >> /etc/apt/sources.list
apt-get update
upgrade

# Copy samba data to new destination and re-create hardlinks
if dpkg -l | grep -q zentyal-samba
then
    service zentyal samba stop
    pkill -9 samba
    pkill -9 smbd
    mkdir -p /var/lib/samba
    cp -r /opt/samba4/private /var/lib/samba/
    cp -r /opt/samba4/var/locks/* /var/lib/samba/
    ln -f /var/lib/samba/private/sam.ldb.d/DC*FORESTDNSZONES* /var/lib/samba/private/dns/sam.ldb.d/
    ln -f /var/lib/samba/private/sam.ldb.d/DC*DOMAINDNSZONES* /var/lib/samba/private/dns/sam.ldb.d/
    ln -f /var/lib/samba/private/sam.ldb.d/metadata.tdb /var/lib/samba/private/dns/sam.ldb.d/
    chown -R root:bind /var/lib/samba/private/dns
    chmod -R g+rw /var/lib/samba/private/dns
    chmod 0600 /var/lib/samba/private/tls/key.pem
    service zentyal samba restart
fi

for i in `seq 1 3`
do
    echo; echo "Forcing pending packages installation..."; echo
    apt-get -f install -y --force-yes -o DPkg::Options::="--force-confdef"
    rm -f /var/lib/dpkg/info/suricata.prerm
    for pkg in zentyal-core zentyal-samba
    do
        rm -f /var/lib/dpkg/info/${pkg}.postinst
    done
    dpkg --configure -a --force-confdef
    apt-get dist-upgrade --purge -y --force-yes -o DPkg::Options::="--force-confdef"
    if [ $? == 0 ]
    then
        echo; echo "Nothing more pending to upgrade"; echo
        break
    fi
done

pkill -9 samba
pkill -9 smbd
service zentyal samba restart > /dev/null 2>&1

if apt-get dist-upgrade --purge -y --force-yes -o DPkg::Options::="--force-confdef"
then
    /usr/share/zentyal/global-action --action saveAllModules
    start samba-ad-dc
    /usr/share/zentyal/initial-setup samba 3.2
    # Restart modules that need to add schemas
    for i in samba mail jabber mail mailfilter
    do
        service zentyal $i restart
    done

    # Purge all no longer needed running services like haproxy, collectd, etc
    apt-get autoremove --purge -y --force-yes -o DPkg::Options::="--force-confdef"

    # Restart regular webserver, Zentyal UI and logs
    service apache2 restart
    service zentyal webadmin restart
    service zentyal logs restart

    echo; echo "Zentyal upgrade finished!"
else
    echo; echo "Zentyal upgrade failed. Full log at /var/log/zentyal/upgrade.log."
fi

apt-get clean

touch $UPGRADE_FILE
