#!/bin/bash

UPGRADE_FILE=/var/lib/zentyal/.upgrade-finished

rm -f $UPGRADE_FILE

export DEBIAN_FRONTEND=noninteractive

function upgrade
{
    apt-get update

    for i in `seq 1 10`
    do
        if apt-get dist-upgrade -y --force-yes --download-only
        then
            break
        else
            echo "Download failed, retrying in 5 seconds..."
            sleep 5
        fi
    done

    apt-get dist-upgrade -y --force-yes -o DPkg::Options::="--force-confdef"
}

sed -i "s/^deb-src/#deb-src/g" /etc/apt/sources.list

echo; echo "Upgrading your current system to the latest packages..."; echo
upgrade

# Install samba if missing and replicate users with s4sync
/usr/share/zentyal/migrate-users-to-samba

# Stop modules to avoid conflicts in listening ports with haproxy
for module in usercorner captiveportal webserver
do
    service zentyal $module stop > /dev/null 2>&1
done

# Stop slapd
service zentyal users stop

echo; echo "Upgrading from Ubuntu 13.10 to 14.04 with Zentyal 3.5..."; echo
sed -i 's/saucy/trusty/g' /etc/apt/sources.list
sed -ri 's/zentyal(.)3.4/zentyal\13.5/g' /etc/apt/sources.list

# Upgrade some conflictive packages first
apt-get update
dpkg -l | grep perl | cut -d' ' -f3 | xargs apt-get install -y --force-yes -o DPkg::Options::="--force-confdef" haproxy

# Continue with the rest of the upgrade rest of the upgrade
upgrade

# FIXME: this process needs a lot of refination, this is a temporary workaround
echo; echo "Forcing pending packages installation..."; echo
for i in zentyal-core freeradius-ldap suricata rabbitmq-server zentyal-samba
do
    rm -f /var/lib/dpkg/info/${i}.postinst
done

service apache2 stop || true

apt-get -f install -y --force-yes -o DPkg::Options::="--force-confdef"
dpkg --configure -a --force-confdef
apt-get dist-upgrade -y --force-yes -o DPkg::Options::="--force-confdef"

service apache2 start || true

if dpkg --configure -a --force-confdef
then
    /usr/share/zentyal/global-action --action saveAllModules
    start samba-ad-dc
    /usr/share/zentyal/initial-setup samba 3.4
    service zentyal samba restart

    echo; echo "Zentyal upgrade finished!"
else
    echo; echo "Zentyal upgrade failed. Full log at /var/log/zentyal/upgrade.log."
fi

apt-get clean

touch $UPGRADE_FILE
